(()=>{var h="http://localhost:3000";async function E(){let r=await fetch(`${h}/api/threads`);if(!r.ok)throw new Error("Failed to load threads");return r.json()}async function C(r){let e=await fetch(`${h}/api/threads/${encodeURIComponent(r)}`);if(!e.ok)throw new Error(`Failed to load thread ${r}`);return e.json()}async function g(r){return fetch(`${h}/api/threads/${encodeURIComponent(r)}`,{method:"DELETE"})}async function _(r){let e=await fetch(`${h}/api/prompt`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!e.ok)throw new Error(await e.text());return e.json()}async function k(r,e,t){return fetch(`${h}/api/threads/${encodeURIComponent(r)}/messages/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}async function M(r,e){return fetch(`${h}/api/threads/${encodeURIComponent(r)}/messages/${encodeURIComponent(e)}`,{method:"DELETE"})}async function L(){let r=await fetch(`${h}/api/files`);if(!r.ok)throw new Error("Failed to load files");return r.json()}window.__consoleHistory__=[];["log","info","warn","error"].forEach(r=>{let e=console[r];console[r]=(...t)=>{window.__consoleHistory__.push({level:r,timestamp:new Date().toISOString(),args:t.map(n=>typeof n=="string"?n:JSON.stringify(n))}),window.__consoleHistory__.length>100&&window.__consoleHistory__.shift(),e.apply(console,t)}});function b(r=[]){return r.map(e=>e.text?typeof e.text=="string"?e.text:typeof e.text.value=="string"?e.text.value:"":"").join(`
`)}var y=document.createElement("template");y.innerHTML=`
  <div class="gpt-container">
    <div class="thread-sidebar">
      <div class="sidebar-header">
        <span>Chats</span>
        <button class="new-chat-btn" title="New Chat">\uFF0B</button>
      </div>
      <input
        class="thread-name-sidebar"
        type="text"
        placeholder="Conversation title\u2026"
      />
      <ul class="thread-list"></ul>
    </div>
    <div class="chat-main">
      <div class="gpt-chat-header">
        <h2 class="chat-title">\u2190 Select or create a chat</h2>
        <button class="delete-chat-btn" title="Delete Chat">\u{1F5D1}\uFE0F</button>
        <button class="view-files-btn">View Files</button>
      </div>
      <div class="gpt-chat-messages"></div>
      <form class="gpt-chat-form">
        <input type="text" placeholder="Type your message\u2026" autocomplete="off"/>
        <button type="submit">Send</button>
      </form>
    </div>
  </div>
`;var u=class extends HTMLElement{constructor(){super(),this._init=!1,this.currentThreadId=null,this.threads=[]}connectedCallback(){this._init||(this._init=!0,this.append(y.content.cloneNode(!0)),this.threadList=this.querySelector(".thread-list"),this.newChatBtn=this.querySelector(".new-chat-btn"),this.threadNameSidebar=this.querySelector(".thread-name-sidebar"),this.chatTitleEl=this.querySelector(".chat-title"),this.deleteChatBtn=this.querySelector(".delete-chat-btn"),this.viewFilesBtn=this.querySelector(".view-files-btn"),this.chatMessages=this.querySelector(".gpt-chat-messages"),this.form=this.querySelector(".gpt-chat-form"),this.input=this.form.querySelector("input"),this.sendBtn=this.form.querySelector("button"),this.threadNameSidebar.style.display="none",this._ensureConfirmModal(),this.newChatBtn.addEventListener("click",()=>this._createNewThread()),this.deleteChatBtn.addEventListener("click",()=>this._deleteCurrentThread()),this.viewFilesBtn.addEventListener("click",()=>this._showFileTree()),this.form.addEventListener("submit",e=>{e.preventDefault(),this.sendMessage(this.input.value)}),this._loadThreads())}_ensureConfirmModal(){if(document.getElementById("confirmModal"))return;let e=document.createElement("div");e.id="confirmModal",e.innerHTML=`
      <div class="modal-content">
        <p class="modal-message"></p>
        <div class="modal-buttons">
          <button class="btn-cancel">Cancel</button>
          <button class="btn-ok">OK</button>
        </div>
      </div>
    `,e.addEventListener("click",t=>{t.target===e&&e.classList.remove("visible")}),e.querySelector(".btn-cancel").addEventListener("click",()=>{e._resolve(!1),e.classList.remove("visible")}),e.querySelector(".btn-ok").addEventListener("click",()=>{e._resolve(!0),e.classList.remove("visible")}),document.body.append(e)}_confirm(e){let t=document.getElementById("confirmModal");return t.querySelector(".modal-message").textContent=e,t.classList.add("visible"),new Promise(n=>t._resolve=n)}_updateControls(){let e=!!this.currentThreadId;this.deleteChatBtn.disabled=!e}async _loadThreads(){try{this.threads=await E(),this.threads.sort((e,t)=>e.title.localeCompare(t.title)),this._renderThreadList(),this.threads.length?await this._selectThread(this.threads[this.threads.length-1].id):this._createNewThread()}catch(e){console.error(e)}}_updateThreadNameSidebarVisibility(){this.threadNameSidebar.style.display=this.currentThreadId===null?"block":"none"}_renderThreadList(){this.threadList.innerHTML="",this.threads.forEach(({id:e,title:t})=>{let n=document.createElement("li");n.dataset.id=e,n.classList.toggle("selected",e===this.currentThreadId);let a=document.createElement("span");a.className="thread-item-label",a.textContent=t||e,a.addEventListener("click",()=>this._selectThread(e));let s=document.createElement("button");s.className="delete-thread-btn",s.title="Delete Chat",s.textContent="\u{1F5D1}\uFE0F",s.addEventListener("click",async d=>{d.stopPropagation(),await this._confirm("Delete this chat?")&&(await g(e),this.threads=this.threads.filter(i=>i.id!==e),this.currentThreadId===e&&(this.currentThreadId=null,this.clearChat(),this.chatTitleEl.textContent="New Chat",this._updateThreadNameSidebarVisibility(),this._updateControls()),this._renderThreadList())}),n.append(a,s),this.threadList.append(n)})}async _deleteCurrentThread(){this.currentThreadId&&await this._confirm("Delete this entire chat?")&&(await g(this.currentThreadId),this.threads=this.threads.filter(e=>e.id!==this.currentThreadId),this.currentThreadId=null,this.clearChat(),this.chatTitleEl.textContent="New Chat",this._renderThreadList(),this._updateThreadNameSidebarVisibility(),this._updateControls())}async _createNewThread(){this.currentThreadId=null,this.clearChat(),this.threadNameSidebar.value="",this._renderThreadList(),this._updateThreadNameSidebarVisibility(),this.chatTitleEl.textContent="New Chat",this._updateControls(),setTimeout(()=>this.threadNameSidebar.focus(),0)}async _selectThread(e){this.currentThreadId=e,this._renderThreadList(),this._updateThreadNameSidebarVisibility(),this._updateControls();try{let{title:t,messages:n}=await C(e);this.chatTitleEl.textContent=t||"Untitled Chat",this.clearChat(),(n||[]).sort((a,s)=>a.created_at-s.created_at).forEach(a=>{let s=new Date(a.created_at*1e3).toLocaleString(),d=b(a.content),{wrap:i}=this.appendMessage(a.role,d,s);i.dataset.msgId=a.id}),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}catch(t){console.error(t)}}clearChat(){this.chatMessages.innerHTML=""}appendMessage(e,t,n){let a=document.createElement("div");a.className=`gpt-chat-message ${e}`;let s=document.createElement("div");s.className="meta",s.textContent=`${e==="user"?"You":"GPT"} \u2022 ${n}`;let d=document.createElement("div");if(d.className="content",d.textContent=t,e==="user"){let i=document.createElement("button");i.className="edit-msg-btn",i.textContent="\u270F\uFE0F",i.addEventListener("click",async()=>{let p=prompt("Edit your message:",t);if(p==null)return;let m=a.dataset.msgId;await k(this.currentThreadId,m,{content:[{type:"text",text:{value:p,annotations:[]}}],metadata:{edited:!0}}),d.textContent=p});let o=document.createElement("button");o.className="delete-msg-btn",o.textContent="\u{1F5D1}\uFE0F",o.addEventListener("click",async()=>{if(!await this._confirm("Delete this message?"))return;let p=a.dataset.msgId;(await M(this.currentThreadId,p)).ok&&a.remove()});let l=document.createElement("div");l.className="msg-actions",l.append(i,o),a.append(l)}return a.append(s,d),this.chatMessages.appendChild(a),{wrap:a}}_highlightSelectedThread(){this.threadList.querySelectorAll("li").forEach(e=>{e.classList.toggle("selected",e.dataset.id===this.currentThreadId)})}async sendMessage(e){if(!e.trim())return;let t=document.createElement("div");t.className="typing-indicator",t.innerHTML="<span></span><span></span><span></span>",this.chatMessages.appendChild(t),this.chatMessages.scrollTop=this.chatMessages.scrollHeight;let n=new Date().toLocaleString(),{wrap:a}=this.appendMessage("user",e,n);this.chatMessages.scrollTop=this.chatMessages.scrollHeight,this.input.disabled=this.sendBtn.disabled=!0,this.input.value="";let{wrap:s}=this.appendMessage("assistant","\u2026","");this.chatMessages.scrollTop=this.chatMessages.scrollHeight;let d={prompt:e,threadId:this.currentThreadId,...this.currentThreadId?{}:{title:this.threadNameSidebar.value.trim()}},i;try{i=await _(d)}catch(c){console.error("sendMessage error:",c),s.remove(),t.remove(),this.input.disabled=this.sendBtn.disabled=!1;return}let{result:o,threadId:l,logs:p,userMessageId:m,assistantMessageId:f}=i;a.dataset.msgId=m,s.dataset.msgId=f,s.remove(),t.remove();let w=new Date().toLocaleString(),x=typeof o=="string"?o:Array.isArray(o.choices)?o.choices.map(c=>c.message?.content||c.text).join(`
`):b(o.content||[]),{wrap:v}=this.appendMessage("assistant",x,w);v.dataset.msgId=f,this.chatMessages.scrollTop=this.chatMessages.scrollHeight,this.input.disabled=this.sendBtn.disabled=!1,this.input.focus(),this.threads.find(c=>c.id===l)||(this.threads.push({id:l,title:this.threadNameSidebar.value.trim()||l}),this._renderThreadList()),this.currentThreadId=l,this._highlightSelectedThread(),this._updateThreadNameSidebarVisibility();let T=this.threads.find(c=>c.id===l);this.chatTitleEl.textContent=T.title||"Untitled Chat"}async _showFileTree(){try{let n=function(s){let d=document.createElement("li");if(Array.isArray(s.children)){let i=document.createElement("span");i.textContent=s.name,i.classList.add("file-node","collapsed"),i.onclick=()=>i.classList.toggle("collapsed"),d.append(i);let o=document.createElement("ul");s.children.forEach(l=>o.append(n(l))),d.append(o)}else{let i=document.createElement("span");i.textContent=s.name,i.classList.add("file-leaf");let o=s.name.split(".").pop();o&&i.classList.add(o.toLowerCase()),d.append(i)}return d},e=await L(),t=document.createElement("div");t.id="fileModal",t.innerHTML='<button class="close">\u2716</button>',t.querySelector(".close").onclick=()=>t.remove();let a=document.createElement("ul");e.forEach(s=>a.append(n(s))),t.append(a),document.body.append(t)}catch(e){console.error(e)}}};customElements.define("gpt-chat",u);document.body.append(document.createElement("gpt-chat"));})();
