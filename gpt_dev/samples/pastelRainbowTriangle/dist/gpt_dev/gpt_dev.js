(()=>{var c="http://localhost:3000";async function C(){let r=await fetch(`${c}/api/threads`);if(!r.ok)throw new Error("Failed to load threads");return r.json()}async function S(r){let e=await fetch(`${c}/api/threads/${encodeURIComponent(r)}`);if(!e.ok)throw new Error(`Failed to load thread ${r}`);return e.json()}async function f(r){return fetch(`${c}/api/threads/${encodeURIComponent(r)}`,{method:"DELETE"})}async function L(r){let e=await fetch(`${c}/api/prompt`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!e.ok)throw new Error(await e.text());return e.json()}async function k(){let r=await fetch(`${c}/api/files`);if(!r.ok)throw new Error("Failed to load files");return r.json()}window.__consoleHistory__=[];["log","info","warn","error"].forEach(r=>{let e=console[r];console[r]=(...t)=>{window.__consoleHistory__.push({level:r,timestamp:new Date().toISOString(),args:t.map(s=>typeof s=="string"?s:JSON.stringify(s))}),window.__consoleHistory__.length>100&&window.__consoleHistory__.shift(),e.apply(console,t)}});function g(r=[]){return r.map(e=>e.text?typeof e.text=="string"?e.text:typeof e.text.value=="string"?e.text.value:"":"").join(`
`)}var b=document.createElement("template");b.innerHTML=`
  <div class="gpt-container">
    <div class="thread-sidebar">
      <div class="sidebar-header">
        <span>Chats</span>
        <button class="new-chat-btn" title="New Chat">\uFF0B</button>
      </div>
      <input
        class="thread-name-sidebar"
        type="text"
        placeholder="Conversation title\u2026"
      />
      <ul class="thread-list"></ul>
    </div>
    <div class="chat-main">
      <div class="gpt-chat-header">
        <h2 class="chat-title">\u2190 Select or create a chat</h2>
        <button class="delete-chat-btn" title="Delete Chat">\u{1F5D1}\uFE0F</button>
        <button class="view-files-btn">View Files</button>
      </div>
      <div class="gpt-chat-messages"></div>
      <form class="gpt-chat-form">
        <input type="text" placeholder="Type your message\u2026" autocomplete="off"/>
        <button type="submit">Send</button>
      </form>
    </div>
  </div>
`;var u=class extends HTMLElement{constructor(){super(),this._init=!1,this.currentThreadId=null,this.threads=[]}connectedCallback(){this._init||(this._init=!0,this.append(b.content.cloneNode(!0)),this.threadList=this.querySelector(".thread-list"),this.newChatBtn=this.querySelector(".new-chat-btn"),this.threadNameSidebar=this.querySelector(".thread-name-sidebar"),this.chatTitleEl=this.querySelector(".chat-title"),this.deleteChatBtn=this.querySelector(".delete-chat-btn"),this.viewFilesBtn=this.querySelector(".view-files-btn"),this.chatMessages=this.querySelector(".gpt-chat-messages"),this.form=this.querySelector(".gpt-chat-form"),this.input=this.form.querySelector("input"),this.sendBtn=this.form.querySelector("button"),this.threadNameSidebar.style.display="none",this._ensureConfirmModal(),this.newChatBtn.addEventListener("click",()=>this._createNewThread()),this.deleteChatBtn.addEventListener("click",()=>this._deleteCurrentThread()),this.viewFilesBtn.addEventListener("click",()=>this._showFileTree()),this.form.addEventListener("submit",e=>{e.preventDefault(),this.sendMessage(this.input.value)}),this._loadThreads())}_ensureConfirmModal(){if(document.getElementById("confirmModal"))return;let e=document.createElement("div");e.id="confirmModal",e.innerHTML=`
      <div class="modal-content">
        <p class="modal-message"></p>
        <div class="modal-buttons">
          <button class="btn-cancel">Cancel</button>
          <button class="btn-ok">OK</button>
        </div>
      </div>
    `,e.addEventListener("click",t=>{t.target===e&&e.classList.remove("visible")}),e.querySelector(".btn-cancel").addEventListener("click",()=>{e._resolve(!1),e.classList.remove("visible")}),e.querySelector(".btn-ok").addEventListener("click",()=>{e._resolve(!0),e.classList.remove("visible")}),document.body.append(e)}_confirm(e){let t=document.getElementById("confirmModal");return t.querySelector(".modal-message").textContent=e,t.classList.add("visible"),new Promise(s=>t._resolve=s)}_updateControls(){this.deleteChatBtn.disabled=!this.currentThreadId}async _loadThreads(){try{this.threads=await C(),this.threads.sort((e,t)=>e.title.localeCompare(t.title)),this._renderThreadList(),this.threads.length?await this._selectThread(this.threads[this.threads.length-1].id):this._createNewThread()}catch(e){console.error(e)}}_updateThreadNameSidebarVisibility(){this.threadNameSidebar.style.display=this.currentThreadId===null?"block":"none"}_renderThreadList(){this.threadList.innerHTML="",this.threads.forEach(({id:e,title:t})=>{let s=document.createElement("li");s.dataset.id=e,s.classList.toggle("selected",e===this.currentThreadId);let i=document.createElement("span");i.className="thread-item-label",i.textContent=t||e,i.addEventListener("click",()=>this._selectThread(e));let a=document.createElement("button");a.className="delete-thread-btn",a.textContent="\u{1F5D1}\uFE0F",a.addEventListener("click",async o=>{o.stopPropagation(),await this._confirm("Delete this chat?")&&(await f(e),this.threads=this.threads.filter(n=>n.id!==e),this.currentThreadId===e&&(this.currentThreadId=null,this.clearChat(),this.chatTitleEl.textContent="New Chat",this._updateThreadNameSidebarVisibility(),this._updateControls()),this._renderThreadList())}),s.append(i,a),this.threadList.append(s)})}async _deleteCurrentThread(){this.currentThreadId&&await this._confirm("Delete this entire chat?")&&(await f(this.currentThreadId),this.threads=this.threads.filter(e=>e.id!==this.currentThreadId),this.currentThreadId=null,this.clearChat(),this.chatTitleEl.textContent="New Chat",this._renderThreadList(),this._updateThreadNameSidebarVisibility(),this._updateControls())}async _createNewThread(){this.currentThreadId=null,this.clearChat(),this.threadNameSidebar.value="",this._renderThreadList(),this._updateThreadNameSidebarVisibility(),this.chatTitleEl.textContent="New Chat",this._updateControls(),setTimeout(()=>this.threadNameSidebar.focus(),0)}async _selectThread(e){this.currentThreadId=e,this._renderThreadList(),this._updateThreadNameSidebarVisibility(),this._updateControls();try{let{title:t,messages:s}=await S(e);this.chatTitleEl.textContent=t||"Untitled Chat",this.clearChat(),(s||[]).sort((i,a)=>i.created_at-a.created_at).forEach(i=>{let a=new Date(i.created_at*1e3).toLocaleString(),o=g(i.content),{wrap:n}=this.appendMessage(i.role,o,a);n.dataset.msgId=i.id}),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}catch(t){console.error(t)}}clearChat(){this.chatMessages.innerHTML=""}appendMessage(e,t,s){let i=document.createElement("div");i.className=`gpt-chat-message ${e}`;let a=document.createElement("div");a.className="meta",a.textContent=`${e==="user"?"You":e==="tool"?"\u{1F527} Tool":"GPT"} \u2022 ${s}`;let o=document.createElement("div");return o.className="content",o.textContent=t,i.append(a,o),this.chatMessages.appendChild(i),{wrap:i}}appendToolEntry(e){let t=new Date().toLocaleTimeString();if(e.type==="function_call"){let s=JSON.stringify(e.arguments);this.appendMessage("tool",`\u{1F6E0}\uFE0F ${e.name}(${s})`,t)}else e.type==="function_result"&&this.appendMessage("tool",`\u2705 ${e.name} \u2192 ${e.result}`,t);this.chatMessages.scrollTop=this.chatMessages.scrollHeight}async sendMessage(e){if(!e.trim())return;let t=document.createElement("div");t.className="typing-indicator",t.innerHTML="<span></span><span></span><span></span>",this.chatMessages.appendChild(t),this.chatMessages.scrollTop=this.chatMessages.scrollHeight;let s=new Date().toLocaleString(),{wrap:i}=this.appendMessage("user",e,s);this.chatMessages.scrollTop=this.chatMessages.scrollHeight,this.input.disabled=this.sendBtn.disabled=!0,this.input.value="";let{wrap:a}=this.appendMessage("assistant","\u2026","");this.chatMessages.scrollTop=this.chatMessages.scrollHeight;let o={prompt:e,threadId:this.currentThreadId,...this.currentThreadId?{}:{title:this.threadNameSidebar.value.trim()}},n;try{n=await L(o)}catch(d){a.remove(),t.remove(),this.input.disabled=this.sendBtn.disabled=!1;let M=new Date().toLocaleString();this.appendMessage("assistant",`\u274C Network Error: ${d.message}`,M);return}let{error:h,errorMessage:p,logs:y,result:m,threadId:l,userMessageId:w,assistantMessageId:x}=n;if(y.forEach(d=>{d.type==="retry"?this.appendMessage("tool",`\u{1F504} Retry attempt ${d.attempt}: ${d.error}`,new Date().toLocaleTimeString()):this.appendToolEntry(d)}),this.input.disabled=this.sendBtn.disabled=!1,this.input.focus(),h){let d=new Date().toLocaleString();this.appendMessage("assistant",`\u274C Error: ${p}`,d);return}a.remove(),t.remove(),i.dataset.msgId=w;let v=new Date().toLocaleString(),T=typeof m=="string"?m:g(m.content||[]),{wrap:E}=this.appendMessage("assistant",T,v);E.dataset.msgId=x,this.chatMessages.scrollTop=this.chatMessages.scrollHeight,this.input.disabled=this.sendBtn.disabled=!1,this.input.focus(),this.threads.find(d=>d.id===l)||(this.threads.push({id:l,title:this.threadNameSidebar.value.trim()||l}),this._renderThreadList()),this.currentThreadId=l,this._highlightSelectedThread(),this._updateThreadNameSidebarVisibility();let _=this.threads.find(d=>d.id===l);this.chatTitleEl.textContent=_.title||"Untitled Chat"}_highlightSelectedThread(){this.threadList.querySelectorAll("li").forEach(e=>{e.classList.toggle("selected",e.dataset.id===this.currentThreadId)})}async _showFileTree(){try{let s=function(a){let o=document.createElement("li");if(Array.isArray(a.children)){let n=document.createElement("span");n.textContent=a.name,n.classList.add("file-node","collapsed"),n.onclick=()=>n.classList.toggle("collapsed"),o.append(n);let h=document.createElement("ul");a.children.forEach(p=>h.append(s(p))),o.append(h)}else{let n=document.createElement("span");n.textContent=a.name,n.classList.add("file-leaf"),o.append(n)}return o},e=await k(),t=document.createElement("div");t.id="fileModal",t.innerHTML='<button class="close">\u2716</button>',t.querySelector(".close").onclick=()=>t.remove();let i=document.createElement("ul");e.forEach(a=>i.append(s(a))),t.append(i),document.body.append(t)}catch(e){console.error(e)}}};customElements.define("gpt-chat",u);document.body.append(document.createElement("gpt-chat"));})();
